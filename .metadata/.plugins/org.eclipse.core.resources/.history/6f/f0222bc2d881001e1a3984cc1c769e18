/*
 * API_debounce.c
 *
 *  Created on: Nov 12, 2023
 *      Author: hollerller
 */

#include <stdio.h>
#include "API_debounce.h"
#include "main.h"
#include "stm32f4xx_hal.h"

// Private declarations

typedef enum{
BUTTON_UP,
BUTTON_FALLING,
BUTTON_DOWN,
BUTTON_RAISING,
} debounceState_t;		// Define a variable with the FMS states

static const uint8_t DEBOUNCETIME = 40; // Debounce delay constant

delay_t debounceDelay;		// Create a variable type delay_t
tick_t initialDelay = DEBOUNCETIME;  // Set the initial time of the delay (40ms)

static debounceState_t debounceState; // Variable for the FSM state
static bool_t edgeDetected;	// variable to check if the edge was detected

void buttonPressed(); // Function to execute when button is pressed
void buttonReleased(); // Function to execute when button is released

void debounceFSM_init(){			// Initialize the FMS
	debounceState = BUTTON_UP;		// Assume that the initial state of the button is UP
	delayInit(&debounceDelay, initialDelay);	// Initialize the delay
	edgeDetected = false; 	// Initialize the edgeDetected variable
}


void debounceFSM_update(){

	uint8_t buttonState = HAL_GPIO_ReadPin(B1_GPIO_Port, B1_Pin);

	switch (debounceState){

	case BUTTON_UP:

		if (!buttonState) {
			debounceState = BUTTON_FALLING;
			delayInit(&debounceDelay, 40);
		}
	break;

	case BUTTON_FALLING:

		if (delayRead(&debounceDelay)){
			if (!buttonState) {
				debounceState = BUTTON_DOWN;
				buttonPressed();
			} else {
				debounceState = BUTTON_UP;
			}
		}

		break;

	case BUTTON_DOWN:

		if (buttonState) {
			debounceState = BUTTON_RAISING;
			//delayWrite(&debounceDelay, 40);
			delayInit(&debounceDelay, 40);
		}

		break;


	case BUTTON_RAISING:

		if (delayRead(&debounceDelay)){
			if (buttonState) {
				debounceState = BUTTON_UP;
				buttonReleased();
			} else {
				debounceState = BUTTON_DOWN;
			}
		}

		break;

	default:

		debounceState = BUTTON_UP;
		edgeDetected = false;
		break;

	}
}

void buttonPressed(){
	edgeDetected = true;
}


void buttonReleased(){

}

bool_t readKey(){

	if (edgeDetected){
		edgeDetected = false;
		return true;
	} else
		return false;

}
