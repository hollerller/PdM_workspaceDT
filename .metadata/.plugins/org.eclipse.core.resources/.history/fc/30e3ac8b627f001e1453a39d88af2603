/*
 * API_debounce.c
 *
 *  Created on: Nov 9, 2023
 *      Author: hollerller
 */

#include "API_delay.h"
#include "API_debounce.h"
#include <stdio.h>
#include "stm32f4xx_hal.h"


#define DEBOUNCETIME 40;

void buttonPressed();			// debe encender el LED
void buttonReleased();		// debe apagar el LED

typedef enum{
BUTTON_UP,
BUTTON_FALLING,
BUTTON_DOWN,
BUTTON_RAISING,
} debounceState_t;

static debounceState_t debounceState;
static bool_t buttonPressed;
static delay_t debounceDelay;


void debounceFSM_init() {
	debounceState = BUTTON_UP;
	buttonPressed = false;
	tick_t initialDelay = DEBOUNCETIME;   // Set the initial time of the delay (200ms)
	delayInit(&debounceDelay, initialDelay); 	// Initialize the counter

}




void debounceFSM_update(){

	uint8_t buttonState = HAL_GPIO_ReadPin(B1_USER_GPIO_Port, B1_USER_Pin);

	switch (debounceState) {

	case BUTTON_UP:

		if (buttonPressed == GPIO_PIN_RESET) {
			debounceState = BUTTON_FALLING;
			delayRead(&debounceDelay);
		}

		break;

	case BUTTON_FALLING:

		if (delayRead(&debounceDelay)){
			if (buttonPressed == GPIO_PIN_RESET) {
				debounceState = BUTTON_DOWN;
				buttonPressed();

			} else {
				debounceState = BUTTON_UP;
			}
		}

		break;
	case BUTTON_DOWN:

		if (buttonPressed == GPIO_PIN_SET) {
			debounceState = BUTTON_RISING;
			delayRead(&debounceDelay);
		}


		break;

	case BUTTON_RAISING:

		if (delayRead(&debounceDelay)){
			if (buttonPressed == GPIO_PIN_SET) {
				debounceState = BUTTON_UP;
				buttonReleased();
			} else {
				debounceState = BUTTON_DOWN;
			}
		}

		break;

	default:
		debounceState = BUTTON_UP;
		buttonPressed = false;
		break;

	}

}


void buttonPressed() {
	  HAL_GPIO_WritePin(LD2_GPIO_Port, LD2_Pin, GPIO_PIN_SET);
}



void buttonReleased(){
	 HAL_GPIO_WritePin(LD2_GPIO_Port, LD2_Pin, GPIO_PIN_RESET);
}



